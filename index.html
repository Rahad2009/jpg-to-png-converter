<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

    <title>Universal Image Converter | Compress & Convert Images Online</title>

    <meta name="description" content="Easily compress and convert images online with our free Universal Image Converter. Supports batch processing for JPEG, PNG, WebP, AVIF, JXL, and more. Reduce image size while maintaining quality.">

    <meta name="keywords" content="image converter, compress image, reduce image size, online image converter, free image compressor, batch image converter, convert image to jpeg, convert image to png, convert image to webp, convert image to avif, convert image to jxl, image optimization">

    <link rel="canonical" href="https://yourwebsite.com/">

    <link rel="icon" href="/logo.png" type="image/png">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://yourwebsite.com/">
    <meta property="og:title" content="Universal Image Converter | Compress & Convert Images Online">
    <meta property="og:description" content="Easily compress and convert images online with our free Universal Image Converter. Supports batch processing for JPEG, PNG, WebP, AVIF, JXL, and more. Reduce image size while maintaining quality.">
    <meta property="og:image" content="https://yourwebsite.com/social-share-image.jpg">

    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://yourwebsite.com/">
    <meta property="twitter:title" content="Universal Image Converter | Compress & Convert Images Online">
    <meta property="twitter:description" content="Easily compress and convert images online with our free Universal Image Converter. Supports batch processing for JPEG, PNG, WebP, AVIF, JXL, and more. Reduce image size while maintaining quality.">
    <meta property="twitter:image" content="https://yourwebsite.com/social-share-image.jpg">

    <meta name="theme-color" content="#3b82f6">


    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Custom styles for the range input thumb */
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #3b82f6; /* blue-500 */
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid #fff;
            margin-top: -6px; /* Adjust to center vertically */
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #3b82f6; /* blue-500 */
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid #fff;
        }

        /* Style for the file entry icon */
        .file-icon {
            width: 24px; /* Adjust size as needed */
            height: 24px; /* Adjust size as needed */
            margin-right: 12px;
            color: #6b7280; /* gray-500 */
            flex-shrink: 0; /* Prevent icon from shrinking */
        }

         /* Style for the processing spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3b82f6; /* blue-500 */
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 font-sans">
    <div class="max-w-3xl mx-auto py-10 px-4">
        <div class="text-center mb-6">
             <img src="/logo.png" alt="Universal Image Converter Logo" class="h-16 mx-auto mb-2 rounded">
            <h1 class="text-3xl font-bold">Universal Image Converter</h1>
        </div>

        <div class="mb-4">
            <label for="format" class="block mb-1 font-semibold">Select output format:</label>
            <select id="format" class="w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="image/jpeg">JPEG</option>
                <option value="image/png">PNG</option>
                <option value="image/webp">WebP</option>
                <option value="image/avif">AVIF</option>
                <option value="image/jxl">JXL</option>
            </select>
        </div>

        <div class="mb-4">
            <label for="quality" class="block mb-1 font-semibold">Quality:
                <span id="qualityValue">75%</span> </label>
            <input type="range" id="quality" min="10" max="100" value="75"
                   class="w-full appearance-none h-2 bg-blue-300 rounded-full outline-none transition-all duration-150 cursor-pointer">
        </div>

        <div id="dropzone" class="border-2 border-dashed border-gray-300 p-6 text-center rounded-md cursor-pointer bg-white hover:bg-gray-50 transition-colors duration-150 mb-4">
            <p class="text-gray-500"><strong>Drop images here or click to upload</strong></p>
            <p class="text-sm text-gray-400">Supports JPEG, PNG, WebP, AVIF, and JXL</p>
            <input type="file" id="fileInput" multiple class="hidden" accept="image/*" />
        </div>

        <button id="downloadAllBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md w-full mb-4 transition-colors duration-150 hidden">
            <i class="fas fa-download mr-2"></i> Download All Compressed Images (Zip)
        </button>


        <div id="fileList" class="mb-4">
            </div>

        <button id="clearAllBtn" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-md w-full mt-2 transition-colors duration-150 hidden">
             <i class="fas fa-trash-alt mr-2"></i> Clear All
        </button>

        <div class="mt-10 p-6 bg-white rounded-md shadow-md text-gray-700">
            <p class="mb-4">Welcome to the <strong>Universal Image Converter</strong>, your free online tool for <strong>batch image compression</strong> and <strong>format conversion</strong>. Easily <strong>reduce image size</strong> for faster website loading, email attachments, or storage savings.</p>
            <p class="mb-4">Our converter supports popular formats including <strong>JPEG, PNG, WebP, AVIF, and JXL</strong>. Simply drag and drop your images or click to upload, select your desired output format and quality, and let our tool do the rest. Get high-quality compressed images quickly and efficiently.</p>

            <h2 class="text-2xl font-semibold mb-3 mt-6 border-b pb-2 border-gray-200">Key Features:</h2>
            <ul class="list-disc list-inside mb-4">
                <li><strong>Batch Processing:</strong> Convert multiple images at once.</li>
                <li><strong>Multiple Format Support:</strong> Convert to JPEG, PNG, WebP, AVIF, JXL.</li>
                <li><strong>Adjustable Quality:</strong> Control the level of compression for lossy formats.</li>
                <li><strong>Fast and Efficient:</strong> Powered by a robust backend for quick conversions.</li>
                <li><strong>Free to Use:</strong> Optimize your images without any cost.</li>
                <li><strong>Browser-Based:</strong> No software installation required.</li>
            </ul>

             <h2 class="text-2xl font-semibold mb-3 mt-6 border-b pb-2 border-gray-200">How to Use:</h2>
             <ol class="list-decimal list-inside mb-4">
                 <li>Drag and drop your images into the dropzone or click to select files.</li>
                 <li>Choose your desired output format (JPEG, PNG, WebP, AVIF, JXL).</li>
                 <li>Adjust the quality slider for lossy formats (JPEG, WebP, AVIF, JXL).</li>
                 <li>Images will be processed automatically.</li>
                 <li>Download individual compressed images or use the "Download All" button for a zip file (zip download feature coming soon!).</li>
             </ol>
        </div>


    </div>

    <script>
        // Get references to DOM elements
        const fileInput = document.getElementById("fileInput");
        const dropzone = document.getElementById("dropzone");
        const fileList = document.getElementById("fileList"); // Container for file entries
        const qualityInput = document.getElementById("quality");
        const qualityValue = document.getElementById("qualityValue");
        // Removed processBtn reference
        const downloadAllBtn = document.getElementById("downloadAllBtn"); // Moved to top
        const clearAllBtn = document.getElementById("clearAllBtn"); // Clear All button

        let selectedFiles = []; // Array to hold the files to be processed

        // Event listener for the quality slider to update the displayed value
        qualityInput.addEventListener("input", () => {
            qualityValue.textContent = `${qualityInput.value}%`;
        });

        // Event listener for the dropzone to trigger the hidden file input when clicked
        dropzone.addEventListener("click", () => fileInput.click());

        // Prevent default drag behaviors and add visual feedback
        dropzone.addEventListener("dragover", (e) => {
            e.preventDefault(); // Prevent default drag behavior
            dropzone.classList.add("bg-blue-50"); // Add highlight class
        });

        // Remove visual feedback when dragging leaves the dropzone
        dropzone.addEventListener("dragleave", () => {
            dropzone.classList.remove("bg-blue-50"); // Remove highlight class
        });

        // Handle dropped files
        dropzone.addEventListener("drop", (e) => {
            e.preventDefault(); // Prevent default drop behavior
            dropzone.classList.remove("bg-blue-50"); // Remove highlight class
            addFiles(e.dataTransfer.files); // Add dropped files to the list
        });

        // Handle files selected via the file input (either by click or drop)
        fileInput.addEventListener("change", (e) => {
            addFiles(e.target.files); // Add selected files to the list
            fileInput.value = ''; // Clear the file input so the same file can be selected again
        });

        // Event listener for the Clear All button
        clearAllBtn.addEventListener("click", () => {
            selectedFiles = []; // Clear the selected files array
            fileList.innerHTML = ""; // Clear the file list UI
            updateButtonStates(); // Update button states
        });


        // Function to add files to the list and display them
        function addFiles(files) {
            Array.from(files).forEach(file => {
                // Prevent adding duplicate files by name (simple check)
                if (!selectedFiles.some(existingFile => existingFile.name === file.name)) {
                     selectedFiles.push(file);
                     displayFileEntry(file); // Create and display the file entry UI
                } else {
                    console.warn(`Skipping duplicate file: ${file.name}`);
                }
            });
            updateButtonStates(); // Update button states based on file count

            // *** Automatically trigger processing after adding files ***
            if (selectedFiles.length > 0) {
                 processAndDisplayResults();
            }
        }

        // Function to display a single file entry in the UI
        function displayFileEntry(file) {
            const fileEntry = document.createElement("div");
            fileEntry.className = "file-entry border rounded-md p-3 mb-2 bg-white flex items-center justify-between shadow-sm";
            fileEntry.dataset.fileName = file.name; // Store filename for easy lookup

            const fileSizeKB = (file.size / 1024).toFixed(2);

            fileEntry.innerHTML = `
                <div class="flex items-center flex-grow mr-4">
                     <i class="fas fa-file-image file-icon"></i>
                    <div class="flex-grow">
                        <p class="file-name font-semibold text-gray-800">${file.name}</p>
                        <p class="status text-sm text-gray-600">Waiting...</p>
                        <p class="size-info text-xs text-gray-500">Original: ${fileSizeKB} KB</p>
                    </div>
                </div>
                <div class="flex-shrink-0 flex items-center">
                    <button class="download-individual-btn text-blue-600 hover:text-blue-800 mr-2 hidden" title="Download this image">
                         <i class="fas fa-download"></i>
                    </button>
                    <button class="remove-file-btn text-red-600 hover:text-red-800 focus:outline-none" title="Remove this image">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;

            // Add event listener to the remove button
            fileEntry.querySelector(".remove-file-btn").addEventListener("click", () => {
                removeFileEntry(file.name);
            });

            // Initial click handler for the individual download button (shows alert)
             const downloadIndividualBtn = fileEntry.querySelector(".download-individual-btn");
             downloadIndividualBtn.onclick = () => {
                 console.log(`Attempted download for ${file.name} before ready.`);
                 alert(`Download link for ${file.name} is not yet ready.`);
             };


            fileList.appendChild(fileEntry);
        }

        // Function to remove a file entry from the list
        function removeFileEntry(fileName) {
            // Remove from the selectedFiles array
            selectedFiles = selectedFiles.filter(file => file.name !== fileName);
            // Remove from the UI
            const fileEntryElement = fileList.querySelector(`[data-file-name="${fileName}"]`);
            if (fileEntryElement) {
                fileList.removeChild(fileEntryElement);
            }
            updateButtonStates(); // Update button states based on file count
        }

        // Function to update the state and text of the buttons
        function updateButtonStates() {
            const count = selectedFiles.length;
            // Removed processBtn text update and disabled state logic

            // Show/hide Clear All button
            if (count > 0 || fileList.children.length > 0) { // Show if files selected or results are displayed
                clearAllBtn.classList.remove('hidden');
            } else {
                clearAllBtn.classList.add('hidden');
            }

            // Hide download all button by default, show only after successful processing
            downloadAllBtn.classList.add('hidden');
        }

        // Function to update the status of a specific file entry in the UI
        function updateFileStatus(fileName, statusText, isError = false) {
            const fileEntryElement = fileList.querySelector(`[data-file-name="${fileName}"]`);
            if (fileEntryElement) {
                const statusElement = fileEntryElement.querySelector(".status");
                // Add spinner for processing status
                if (statusText === "Processing...") {
                    statusElement.innerHTML = `<span class="spinner"></span> ${statusText}`;
                } else {
                    statusElement.innerHTML = statusText; // Clear spinner
                }

                // Show/hide individual download button based on status
                 const downloadIndividualBtn = fileEntryElement.querySelector(".download-individual-btn");

                if (isError) {
                    statusElement.classList.add("text-red-600");
                    statusElement.classList.remove("text-gray-600", "text-green-600");
                    downloadIndividualBtn.classList.add('hidden'); // Hide download button on error
                     // Reset click handler on error
                     downloadIndividualBtn.onclick = () => {
                         console.log(`Attempted download for ${fileName} on error status.`);
                         alert(`Download link for ${fileName} is not available due to processing error.`);
                     };
                } else if (statusText === "Complete") {
                     statusElement.classList.add("text-green-600");
                     statusElement.classList.remove("text-gray-600", "text-red-600");
                     downloadIndividualBtn.classList.remove('hidden'); // Show download button on complete

                     // *** Update individual download button click handler ***
                     const format = document.getElementById("format").value.split("/")[1];
                     // Need to get the *processed* filename from the backend result, not reconstruct it.
                     // Assuming the backend result includes the final filename.
                     // For now, reconstructing based on original name and selected format.
                     const originalFileEntry = selectedFiles.find(file => file.name === fileName);
                     const outputFilename = originalFileEntry ? `${path.parse(originalFileEntry.name).name}.${format}` : `${path.parse(fileName).name}.${format}`;

                     console.log(`Setting download handler for ${fileName}. Output filename: ${outputFilename}`); // Log when handler is set

                     downloadIndividualBtn.onclick = () => {
                         console.log(`Triggering download for ${outputFilename}`); // Log when download is triggered
                         // Trigger download by navigating to the new backend download route
                         window.open(`/download/${outputFilename}`, '_blank');
                     };

                }
                else {
                     statusElement.classList.remove("text-red-600", "text-green-600");
                     statusElement.classList.add("text-gray-600");
                     downloadIndividualBtn.classList.add('hidden'); // Hide download button otherwise
                     // Reset click handler for non-complete states
                     downloadIndividualBtn.onclick = () => {
                         console.log(`Attempted download for ${fileName} before complete status.`);
                         alert(`Download link for ${fileName} is not yet ready.`);
                     };
                }
            }
        }

        // Function to update the size info of a specific file entry in the UI (for reduced size)
        function updateFileSizeInfo(fileName, originalSize, compressedSize, status) {
            const fileEntryElement = fileList.querySelector(`[data-file-name="${fileName}"]`);
            if (fileEntryElement) {
                const sizeInfoElement = fileEntryElement.querySelector(".size-info");
                const originalSizeKB = (originalSize / 1024).toFixed(2);

                if (status === "Complete") {
                    const compressedSizeKB = (compressedSize / 1024).toFixed(2);
                    const reduction = originalSize > 0 ? (((originalSize - compressedSize) / originalSize) * 100).toFixed(0) : 0;
                    sizeInfoElement.textContent = `${originalSizeKB} KB → ${compressedSizeKB} KB (${reduction}% smaller)`;
                     // Adjusted format to match screenshot more closely
                } else {
                     sizeInfoElement.textContent = `Original: ${originalSizeKB} KB`;
                }
            }
         }


        // Async function to handle image processing and display results
        async function processAndDisplayResults() {
            const files = selectedFiles; // Use the selectedFiles array
            const format = document.getElementById("format").value.split("/")[1];
            const quality = qualityInput.value;

            if (files.length === 0) {
                // This case should be less likely now that processing is automatic,
                // but good to keep as a safeguard.
                return;
            }

            // Update status to Processing for all files
            files.forEach(file => updateFileStatus(file.name, "Processing..."));
            // processBtn is removed, no need to disable it.
            downloadAllBtn.classList.add('hidden'); // Hide download all button

            const formData = new FormData();
            files.forEach(file => formData.append("images", file));

            try {
                const response = await fetch(`/compress?format=${format}&quality=${quality}`, {
                    method: "POST",
                    body: formData,
                });

                if (!response.ok) {
                    const errorData = await response.json(); // Expect JSON error from backend
                    alert(`Processing failed: ${response.status} ${response.statusText}. ${errorData.error || ''}`);
                     files.forEach(file => updateFileStatus(file.name, "Error", true)); // Set status to Error
                } else {
                    const results = await response.json(); // Expect JSON array of results

                    // Update UI with results for each file
                    let allComplete = true;
                    let successfullyProcessedCount = 0;
                    results.forEach(result => {
                        updateFileStatus(result.name, result.status, result.status !== "Complete");
                        updateFileSizeInfo(result.name, result.originalSize, result.compressedSize, result.status);
                        if (result.status !== "Complete") {
                            allComplete = false; // If any file failed, don't show download button
                        } else {
                            successfullyProcessedCount++;
                        }
                    });

                    // If all files processed successfully, show the Download All button
                    if (allComplete && results.length > 0) {
                         downloadAllBtn.classList.remove('hidden');
                         // Update Download All button text with count
                         downloadAllBtn.textContent = `Download All (${successfullyProcessedCount} image${successfullyProcessedCount === 1 ? '' : 's'})`;

                         // *** Update Download All button click handler ***
                         downloadAllBtn.onclick = () => {
                              console.log("Triggering Download All zip."); // Log when Download All is triggered
                              // Trigger download by navigating to the new backend download-all-zip route
                              window.open('/download-all-zip', '_blank');
                         };

                    } else if (results.length === 0) {
                         alert("No files were processed successfully.");
                    }
                }

            } catch (error) {
                alert(`An error occurred during processing: ${error.message}`);
                console.error("Fetch error:", error);
                 files.forEach(file => updateFileStatus(file.name, "Error", true)); // Set status to Error
            } finally {
                 // processBtn is removed, no need to re-enable it.
                 updateButtonStates(); // Ensure button states are correct (hides download if needed)
            }
        }

        // Initialize button states on page load
        updateButtonStates();

        // Helper function to parse filename and extension (used for constructing download URL)
        // This is a basic implementation. Node's path module is more robust.
        const path = {
            parse: (filePath) => {
                const lastDot = filePath.lastIndexOf('.');
                if (lastDot <= 0) { // Handle files with no extension or dot at the beginning
                    return { name: filePath, ext: '' };
                }
                return {
                    name: filePath.substring(0, lastDot),
                    ext: filePath.substring(lastDot)
                };
            },
            extname: (filePath) => {
                const lastDot = filePath.lastIndexOf('.');
                if (lastDot < 0) return '';
                return filePath.substring(lastDot);
            }
        };

    </script>
</body>
</html>
