import express from "express";
import fs from "fs";
import path from "path";
import multer from "multer";
import sharp from "sharp";
import archiver from "archiver";
import { fileURLToPath } from "url";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const app = express();
const PORT = process.env.PORT || 3000;

// Middleware to serve static files
app.use(express.static(path.join(__dirname, "public")));
app.use(express.urlencoded({ extended: true }));
app.use(express.json());

// Set up Multer for file uploads
const storage = multer.diskStorage({
  destination: (req, file, cb) => {
    const uploadPath = path.join(__dirname, "uploads");
    if (!fs.existsSync(uploadPath)) fs.mkdirSync(uploadPath);
    cb(null, uploadPath);
  },
  filename: (req, file, cb) => {
    cb(null, `${Date.now()}-${file.originalname}`);
  },
});

const upload = multer({ storage });

// Serve the HTML file
app.get("/", (req, res) => {
  res.sendFile(path.join(__dirname, "public/index.html"));
});

// Handle image conversion
app.post("/convert", upload.array("images"), async (req, res) => {
  const format = req.body.format;
  const quality = parseInt(req.body.quality) || 75;
  const convertedDir = path.join(__dirname, "converted");

  if (!fs.existsSync(convertedDir)) fs.mkdirSync(convertedDir);

  const outputFiles = [];

  try {
    for (let file of req.files) {
      const outputFilename = `${path.parse(file.originalname).name}.${format}`;
      const outputPath = path.join(convertedDir, outputFilename);

      await sharp(file.path)
        .toFormat(format, { quality })
        .toFile(outputPath);

      outputFiles.push({ filename: outputFilename, path: `/converted/${outputFilename}` });
    }

    res.json({ success: true, files: outputFiles });
  } catch (err) {
    res.status(500).json({ success: false, error: err.message });
  }
});

// Download all as ZIP
app.get("/download-all.zip", (req, res) => {
  const zipPath = path.join(__dirname, "converted.zip");
  const output = fs.createWriteStream(zipPath);
  const archive = archiver("zip", { zlib: { level: 9 } });

  output.on("close", () => {
    res.download(zipPath);
  });

  archive.pipe(output);
  archive.directory(path.join(__dirname, "converted"), false);
  archive.finalize();
});

// Serve converted images
app.use("/converted", express.static(path.join(__dirname, "converted")));

// Start server
app.listen(PORT, () => {
  console.log(`ðŸš€ Server is running on http://localhost:${PORT}`);
});
