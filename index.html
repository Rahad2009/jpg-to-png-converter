<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="google-site-verification" content="HaTLUezjQ3wItVjyqKp7hAuUu7BNpTl9bkzOcreKeE8" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

    <title>Universal Image Converter | Compress & Convert Images Online</title>

    <meta name="description" content="Easily compress and convert images online with our free Universal Image Converter. Supports batch processing for JPEG, PNG, WebP, AVIF, JXL, and more. Reduce image size while maintaining quality.">

    <meta name="keywords" content="image converter, compress image, reduce image size, online image converter, free image compressor, batch image converter, convert image to jpeg, convert image to png, convert image to webp, convert image to avif, convert image to jxl, image optimization">

    <link rel="canonical" href="https://jpg-to-png-converter.onrender.com/">

    <link rel="icon" href="/logo.png" type="image/png">

    <meta property="og:type" content="website">
    <meta property="og:url" content="https://jpg-to-png-converter.onrender.com/">
    <meta property="og:title" content="Universal Image Converter | Compress & Convert Images Online">
    <meta property="og:description" content="Easily compress and convert images online with our free Universal Image Converter. Supports batch processing for JPEG, PNG, WebP, AVIF, JXL, and more. Reduce image size while maintaining quality.">
    <meta property="og:image" content="https://jpg-to-png-converter.onrender.com/social-share-image.jpg"> <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://jpg-to-png-converter.onrender.com/">
    <meta property="twitter:title" content="Universal Image Converter | Compress & Convert Images Online">
    <meta property="twitter:description" content="Easily compress and convert images online with our free Universal Image Converter. Supports batch processing for JPEG, PNG, WebP, AVIF, JXL, and more. Reduce image size while maintaining quality.">
    <meta property="twitter:image" content="https://jpg-to-png-converter.onrender.com/social-share-image.jpg"> <meta name="theme-color" content="#3b82f6">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles for the range input thumb */
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #3b82f6; /* blue-500 */
            cursor: pointer;
            border-radius: 50%;
            border: 3px solid #fff; /* Slightly thicker border */
            margin-top: -6px; /* Adjust to center vertically */
            box-shadow: 0 2px 4px rgba(0,0,0,0.2); /* Add subtle shadow */
            transition: background 0.15s ease-in-out, border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
             background: #2563eb; /* blue-600 on hover */
             box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #3b82f6; /* blue-500 */
            cursor: pointer;
            border-radius: 50%;
            border: 3px solid #fff; /* Slightly thicker border */
            box-shadow: 0 2px 4px rgba(0,0,0,0.2); /* Add subtle shadow */
             transition: background 0.15s ease-in-out, border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
         input[type="range"]::-moz-range-thumb:hover {
             background: #2563eb; /* blue-600 on hover */
             box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }


        /* Style for the file entry icon */
        .file-icon {
            width: 24px; /* Adjust size as needed */
            height: 24px; /* Adjust size as needed */
            margin-right: 12px;
            color: #6b7280; /* gray-500 */
            flex-shrink: 0; /* Prevent icon from shrinking */
        }

         /* Style for the processing spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3b82f6; /* blue-500 */
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Style for the image preview thumbnail */
        .file-preview {
            width: 40px; /* Adjust size as needed */
            height: 40px; /* Adjust size as needed */
            object-fit: cover; /* Maintain aspect ratio */
            margin-right: 12px;
            border-radius: 4px; /* Slightly rounded corners */
            border: 1px solid #d1d5db; /* gray-300 subtle border */
        }
        .file-entry {
             border-radius: 0.5rem; /* Match Tailwind rounded-md */
             transition: transform 0.1s ease-in-out; /* Subtle hover effect */
        }
         .file-entry:hover {
             transform: translateY(-2px); /* Lift slightly on hover */
             box-shadow: 0 4px 6px rgba(0,0,0,0.1); /* Add shadow on hover */
         }
         /* Style for the status text */
         .status {
             font-weight: 600; /* Semibold */
         }
          .status.text-green-600 {
              font-weight: 700; /* Bold for complete */
          }
           .status.text-red-600 {
              font-weight: 700; /* Bold for error */
          }

          /* Removed progress bar styles */
    </style>

    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "SoftwareApplication",
      "name": "Universal Image Converter",
      "operatingSystem": "Web",
      "applicationCategory": "https://schema.org/MultimediaApplication",
      "url": "https://jpg-to-png-converter.onrender.com/",
      "description": "Easily compress and convert images online with our free Universal Image Converter. Supports batch processing for JPEG, PNG, WebP, AVIF, JXL, and more. Reduce image size while maintaining quality."
      // You can add more properties here if applicable, for example:
      // "aggregateRating": {
      //   "@type": "AggregateRating",
      //   "ratingValue": "4.5", // Replace with actual rating
      //   "reviewCount": "100" // Replace with actual review count
      // },
      // "offers": {
      //   "@type": "Offer",
      //   "price": "0",
      //   "priceCurrency": "USD"
      // }
    }
    </script>

</head>
<body class="bg-gray-100 text-gray-900 font-sans">
    <div class="max-w-3xl mx-auto py-10 px-4">
        <div class="text-center mb-8"> <img src="/logo.png" alt="Universal Image Converter Logo" class="h-20 mx-auto mb-4 rounded"> <h1 class="text-4xl font-bold text-gray-800">Universal Image Converter</h1> <p class="text-gray-600 mt-2">Compress and convert your images quickly and easily.</p> </div>

        <div class="mb-6 p-4 bg-white rounded-md shadow-sm"> <label for="format" class="block mb-2 font-semibold text-gray-700">Select output format:</label> <select id="format" class="w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"> <option value="image/jpeg">JPEG</option>
                <option value="image/png">PNG</option>
                <option value="image/webp">WebP</option>
                <option value="image/avif">AVIF</option>
                <option value="image/jxl">JXL</option>
            </select>
        </div>

        <div class="mb-6 p-4 bg-white rounded-md shadow-sm"> <label for="quality" class="block mb-2 font-semibold text-gray-700">Quality:
                <span id="qualityValue">75%</span> </label>
            <input type="range" id="quality" min="10" max="100" value="75"
                   class="w-full appearance-none h-2 bg-blue-300 rounded-full outline-none focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-150 cursor-pointer"> </div>

        <div id="dropzone" class="border-2 border-dashed border-blue-300 p-8 text-center rounded-lg cursor-pointer bg-white hover:bg-blue-50 transition-colors duration-200 ease-in-out mb-6 shadow-md"> <div class="text-blue-500 mb-2"><i class="fas fa-cloud-upload-alt text-4xl"></i></div> <p class="text-blue-700 font-semibold">Drop images here or click to upload</p> <p class="text-sm text-gray-500 mt-1">Supports JPEG, PNG, WebP, AVIF, and JXL</p>
            <input type="file" id="fileInput" multiple class="hidden" accept="image/*" />
        </div>

        <button id="downloadAllBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold px-6 py-3 rounded-md w-full mb-6 transition-colors duration-200 ease-in-out shadow-md hover:shadow-lg hidden"> <i class="fas fa-download mr-3"></i> Download All Compressed Images (Zip)
        </button>


        <div id="fileList" class="mb-6">
            </div>

        <button id="clearAllBtn" class="bg-gray-400 hover:bg-gray-500 text-white font-semibold px-6 py-3 rounded-md w-full mt-4 transition-colors duration-200 ease-in-out shadow-md hover:shadow-lg hidden"> <i class="fas fa-trash-alt mr-2"></i> Clear All
        </button>

        <div class="mt-12 p-8 bg-white rounded-lg shadow-lg text-gray-700"> <p class="mb-6 text-lg leading-relaxed">Welcome to the <strong>Universal Image Converter</strong>, your free online tool for <strong>batch image compression</strong> and <strong>format conversion</strong>. Easily <strong>reduce image size</strong> for faster website loading, email attachments, or storage savings.</p>
            <p class="mb-6 text-lg leading-relaxed">Our converter supports popular formats including <strong>JPEG, PNG, WebP, AVIF, and JXL</strong>. Simply drag and drop your images or click to upload, select your desired output format and quality, and let our tool do the rest. Get high-quality compressed images quickly and efficiently.</p>

            <h2 class="text-2xl font-bold mb-4 mt-8 border-b pb-3 border-gray-300 text-gray-800">Key Features:</h2> <ul class="list-disc list-inside mb-6 text-gray-700 space-y-2"> <li><strong>Batch Processing:</strong> Convert multiple images at once.</li>
                <li><strong>Multiple Format Support:</strong> Convert to JPEG, PNG, WebP, AVIF, JXL.</li>
                <li><strong>Adjustable Quality:</strong> Control the level of compression for lossy formats.</li>
                <li><strong>Fast and Efficient:</strong> Powered by a robust backend for quick conversions.</li>
                <li><strong>Free to Use:</strong> Optimize your images without any cost.</li>
                <li><strong>Browser-Based:</strong> No software installation required.</li>
            </ul>

             <h2 class="text-2xl font-bold mb-4 mt-8 border-b pb-3 border-gray-300 text-gray-800">How to Use:</h2> <ol class="list-decimal list-inside mb-6 text-gray-700 space-y-2"> <li>Drag and drop your images into the dropzone or click to select files.</li>
                 <li>Choose your desired output format (JPEG, PNG, WebP, AVIF, JXL).</li>
                 <li>Adjust the quality slider for lossy formats (JPEG, WebP, AVIF, JXL).</li>
                 <li>Images will be processed automatically.</li>
                 <li>Download individual compressed images or use the "Download All" button for a zip file (zip download feature coming soon!).</li>
             </ol>
        </div>


    </div>

    <script>
        // Get references to DOM elements
        const fileInput = document.getElementById("fileInput");
        const dropzone = document.getElementById("dropzone");
        const fileList = document.getElementById("fileList"); // Container for file entries
        const qualityInput = document.getElementById("quality");
        const qualityValue = document.getElementById("qualityValue");
        const downloadAllBtn = document.getElementById("downloadAllBtn"); // Moved to top
        const clearAllBtn = document.getElementById("clearAllBtn"); // Clear All button
        // Removed progress bar element references
        // const progressBarContainer = document.getElementById("progressBarContainer");
        // const progressBar = document.getElementById("progressBar");
        // const progressBarText = document.getElementById("progressBarText");
        // const progressStatusText = document.getElementById("progressStatusText");


        let selectedFiles = []; // Array to hold the files to be processed
        // Removed processedCount variable
        // let processedCount = 0;


        // Event listener for the quality slider to update the displayed value
        qualityInput.addEventListener("input", () => {
            qualityValue.textContent = `${qualityInput.value}%`;
        });

        // Event listener for the dropzone to trigger the hidden file input when clicked
        dropzone.addEventListener("click", () => fileInput.click());

        // Prevent default drag behaviors and add visual feedback
        dropzone.addEventListener("dragover", (e) => {
            e.preventDefault(); // Prevent default drag behavior
            dropzone.classList.add("bg-blue-50"); // Add highlight class
             dropzone.classList.add("border-blue-500"); // Darker border on drag over
        });

        // Remove visual feedback when dragging leaves the dropzone
        dropzone.addEventListener("dragleave", () => {
            dropzone.classList.remove("bg-blue-50"); // Remove highlight class
             dropzone.classList.remove("border-blue-500"); // Reset border
        });

        // Handle dropped files
        dropzone.addEventListener("drop", (e) => {
            e.preventDefault(); // Prevent default drop behavior
            dropzone.classList.remove("bg-blue-50"); // Remove highlight class
             dropzone.classList.remove("border-blue-500"); // Reset border
            addFiles(e.dataTransfer.files); // Add dropped files to the list
        });

        // Handle files selected via the file input (either by click or drop)
        fileInput.addEventListener("change", (e) => {
            addFiles(e.target.files); // Add selected files to the list
            fileInput.value = ''; // Clear the file input so the same file can be selected again
        });

        // Event listener for the Clear All button
        clearAllBtn.addEventListener("click", () => {
            selectedFiles = []; // Clear the selected files array
            fileList.innerHTML = ""; // Clear the file list UI
            updateButtonStates(); // Update button states - This will now hide Download All
             // Removed progress bar hiding logic
            // progressBarContainer.classList.add('hidden');
            // progressBar.style.width = '0%';
            // progressBarText.textContent = '0';
            // progressStatusText.textContent = 'Processing...';
            // processedCount = 0;
            // progressBar.classList.remove('bg-red-500', 'bg-yellow-500');
            // progressBar.classList.add('bg-blue-500');
        });


        // Function to add files to the list and display them
        function addFiles(files) {
            Array.from(files).forEach(file => {
                // Prevent adding duplicate files by name (simple check)
                if (!selectedFiles.some(existingFile => existingFile.name === file.name)) {
                     selectedFiles.push(file);
                     displayFileEntry(file); // Create and display the file entry UI
                } else {
                    console.warn(`Skipping duplicate file: ${file.name}`);
                }
            });
            updateButtonStates(); // Update button states based on file count - This will hide Download All initially

            // *** Automatically trigger processing after adding files ***
            if (selectedFiles.length > 0) {
                 processAndDisplayResults();
            }
        }

        // Function to display a single file entry in the UI
        function displayFileEntry(file) {
            const fileEntry = document.createElement("div");
            fileEntry.className = "file-entry border rounded-md p-3 mb-2 bg-white flex items-center justify-between shadow-sm";
            fileEntry.dataset.fileName = file.name; // Store filename for easy lookup

            const fileSizeKB = (file.size / 1024).toFixed(2);

            fileEntry.innerHTML = `
                <div class="flex items-center flex-grow mr-4">
                     <img class="file-preview" src="" alt="Preview of ${file.name}">
                     <i class="fas fa-file-image file-icon hidden"></i>
                    <div class="flex-grow">
                        <p class="file-name font-semibold text-gray-800">${file.name}</p>
                        <p class="status text-sm text-gray-600">Waiting...</p>
                        <p class="size-info text-xs text-gray-500">Original: ${fileSizeKB} KB <span class="estimated-size hidden">(Estimated: N/A)</span></p>
                    </div>
                </div>
                <div class="flex-shrink-0 flex items-center">
                    <button class="download-individual-btn text-blue-600 hover:text-blue-800 mr-2 hidden" title="Download this image">
                         <i class="fas fa-download"></i>
                    </button>
                    <button class="remove-file-btn text-red-600 hover:text-red-800 focus:outline-none" title="Remove this image">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;

            // Add event listener to the remove button
            fileEntry.querySelector(".remove-file-btn").addEventListener("click", () => {
                removeFileEntry(file.name);
                updateButtonStates(); // Update button states - This will now hide Download All
            });

            // Initial click handler for the individual download button (shows alert)
             const downloadIndividualBtn = fileEntry.querySelector(".download-individual-btn");
             downloadIndividualBtn.onclick = () => {
                 console.log(`Attempted download for ${file.name} before ready.`);
                 alert(`Download link for ${file.name} is not yet ready.`);
             };

            fileList.appendChild(fileEntry);

            // Read the file to display a preview
            const reader = new FileReader();
            reader.onload = (e) => {
                const previewImg = fileEntry.querySelector('.file-preview');
                 const fileIcon = fileEntry.querySelector('.file-icon');
                previewImg.src = e.target.result;
                 previewImg.classList.remove('hidden'); // Show the preview
                 fileIcon.classList.add('hidden'); // Hide the default icon
            };
             reader.onerror = (e) => {
                console.error("FileReader error: ", e);
                 // Fallback to showing the file icon if preview fails
                 const previewImg = fileEntry.querySelector('.file-preview');
                 const fileIcon = fileEntry.querySelector('.file-icon');
                 previewImg.classList.add('hidden');
                 fileIcon.classList.remove('hidden');
             };
            reader.readAsDataURL(file);
        }

        // Function to remove a file entry from the list
        function removeFileEntry(fileName) {
            // Remove from the selectedFiles array
            selectedFiles = selectedFiles.filter(file => file.name !== fileName);
            // Remove from the UI
            const fileEntryElement = fileList.querySelector(`[data-file-name="${fileName}"]`);
            if (fileEntryElement) {
                fileList.removeChild(fileEntryElement);
            }
            updateButtonStates(); // Update button states based on file count
        }

        // Function to update the state and text of the buttons
        function updateButtonStates() {
            const count = selectedFiles.length;
            const fileEntryCount = fileList.children.length; // Check actual UI elements

            // Show/hide Clear All button
            if (count > 0 || fileEntryCount > 0) { // Show if files selected or results are displayed
                clearAllBtn.classList.remove('hidden');
            } else {
                clearAllBtn.classList.add('hidden');
            }

            // *** Hide downloadAllBtn if there are no files in the list ***
            if (fileEntryCount === 0) {
                 downloadAllBtn.classList.add('hidden');
                 console.log("Download All button hidden: No file entries in UI."); // Log when hidden
                 // Reset click handler to placeholder if button is hidden
                 downloadAllBtn.onclick = () => {
                    alert("Download All functionality is not yet fully implemented in this version.");
                 };
            }
             // Note: The logic to *show* the downloadAllBtn when all files are complete
             // remains in the processAndDisplayResults function.
        }

        // Function to update the status of a specific file entry in the UI
        function updateFileStatus(fileName, statusText, isError = false, errorMessage = null) { // Added errorMessage parameter
            const fileEntryElement = fileList.querySelector(`[data-file-name="${fileName}"]`);
            if (fileEntryElement) {
                const statusElement = fileEntryElement.querySelector(".status");
                // Add spinner for processing status
                if (statusText === "Processing...") {
                    statusElement.innerHTML = `<span class="spinner"></span> ${statusText}`;
                } else if (isError) { // Display error message if status is Error
                    statusElement.innerHTML = `Error: ${errorMessage || 'Unknown error'}`;
                }
                else {
                    statusElement.innerHTML = statusText; // Clear spinner or show complete
                }


                // Show/hide individual download button based on status
                 const downloadIndividualBtn = fileEntryElement.querySelector(".download-individual-btn");

                if (isError) {
                    statusElement.classList.add("text-red-600");
                    statusElement.classList.remove("text-gray-600", "text-green-600");
                    downloadIndividualBtn.classList.add('hidden'); // Hide download button on error
                     // Reset click handler on error
                     downloadIndividualBtn.onclick = () => {
                         console.log(`Attempted download for ${fileName} on error status.`);
                         alert(`Download link for ${fileName} is not available due to processing error.`);
                     };
                } else if (statusText === "Complete") {
                     statusElement.classList.add("text-green-600");
                     statusElement.classList.remove("text-gray-600", "text-red-600");
                     downloadIndividualBtn.classList.remove('hidden'); // Show download button on complete

                     // *** Update individual download button click handler ***
                     const format = document.getElementById("format").value.split("/")[1];
                     // Need to get the *processed* filename from the backend result, not reconstruct it.
                     // Assuming the backend result includes the final filename.
                     // For now, reconstructing based on original name and selected format.
                     const originalFileEntry = selectedFiles.find(file => file.name === fileName);
                     const outputFilename = originalFileEntry ? `${path.parse(originalFileEntry.name).name}.${format}` : `${path.parse(fileName).name}.${format}`;

                     console.log(`Setting download handler for ${fileName}. Output filename: ${outputFilename}`); // Log when handler is set

                     downloadIndividualBtn.onclick = () => {
                         console.log(`Triggering download for ${outputFilename}`); // Log when download is triggered
                         // Trigger download by navigating to the new backend download route
                         window.open(`/download/${outputFilename}`, '_blank');
                     };

                }
                else {
                     statusElement.classList.remove("text-red-600", "text-green-600");
                     statusElement.classList.add("text-gray-600");
                     downloadIndividualBtn.classList.add('hidden'); // Hide download button otherwise
                     // Reset click handler for non-complete states
                     downloadIndividualBtn.onclick = () => {
                         console.log(`Attempted download for ${fileName} before complete status.`);
                         alert(`Download link for ${fileName} is not yet ready.`);
                     };
                }
            }
        }

        // Function to update the size info of a specific file entry in the UI (for reduced size)
        function updateFileSizeInfo(fileName, originalSize, compressedSize, status) {
            const fileEntryElement = fileList.querySelector(`[data-file-name="${fileName}"]`);
            if (fileEntryElement) {
                const sizeInfoElement = fileEntryElement.querySelector(".size-info");
                const originalSizeKB = (originalSize / 1024).toFixed(2);

                if (status === "Complete") {
                    const compressedSizeKB = (compressedSize / 1024).toFixed(2);
                    const reduction = originalSize > 0 ? (((originalSize - compressedSize) / originalSize) * 100).toFixed(0) : 0;
                    sizeInfoElement.textContent = `${originalSizeKB} KB → ${compressedSizeKB} KB (${reduction}% smaller)`;
                     // Adjusted format to match screenshot more closely
                } else {
                     sizeInfoElement.innerHTML = `Original: ${originalSizeKB} KB <span class="estimated-size hidden">(Estimated: N/A)</span>`;
                     // Keep the placeholder if not complete
                }
            }
         }


        // Async function to handle image processing and display results
        async function processAndDisplayResults() {
            const files = selectedFiles; // Use the selectedFiles array
            const format = document.getElementById("format").value.split("/")[1];
            const quality = qualityInput.value;

            if (files.length === 0) {
                // This case should be less likely now that processing is automatic,
                // but good to keep as a safeguard.
                return;
            }

            // Update status to Processing for all files
            files.forEach(file => updateFileStatus(file.name, "Processing..."));
            downloadAllBtn.classList.add('hidden'); // Hide download all button at the start of processing
             console.log("Download All button hidden at start of processing."); // Log when hidden


            const formData = new FormData();
            files.forEach(file => formData.append("images", file));

            try {
                const response = await fetch(`/compress?format=${format}&quality=${quality}`, {
                    method: "POST",
                    body: formData,
                });

                if (!response.ok) {
                    let errorDetails = `Processing failed: ${response.status} ${response.statusText}.`;
                    try {
                        const errorData = await response.json();
                        errorDetails += ` ${errorData.error || 'Unknown error from server.'}`;
                         // Pass the error message to updateFileStatus for each file
                        files.forEach(file => updateFileStatus(file.name, "Error", true, errorData.error || 'Processing failed.'));
                    } catch (jsonError) {
                        // If response body is not JSON on a non-OK status
                        console.error("Failed to parse JSON from error response:", jsonError);
                        errorDetails += ` Server returned non-JSON error or empty response.`;
                         // Set a generic error status on the frontend
                         files.forEach(file => updateFileStatus(file.name, "Error", true, 'Server error.'));
                    }
                    alert(errorDetails);


                } else {
                    // Response is OK, expect JSON results
                    const results = await response.json();

                    // Update UI with results for each file
                    let allComplete = true;
                    let successfullyProcessedCount = 0;
                    results.forEach(result => {
                        // Pass the error message from the result if available
                        updateFileStatus(result.name, result.status, result.status !== "Complete", result.errorMessage);
                        updateFileSizeInfo(result.name, result.originalSize, result.compressedSize, result.status);
                        if (result.status !== "Complete") {
                            allComplete = false; // If any file failed, don't show download button
                        } else {
                            successfullyProcessedCount++;
                        }
                    });

                    // After processing all results:
                    if (allComplete && results.length > 0) {
                         downloadAllBtn.classList.remove('hidden');
                         console.log("Download All button shown: All files complete."); // Log when shown
                         // Update Download All button text with count
                         downloadAllBtn.textContent = `Download All (${successfullyProcessedCount} image${successfullyProcessedCount === 1 ? '' : 's'})`;

                         // *** Update Download All button click handler ***
                         downloadAllBtn.onclick = () => {
                              console.log("Triggering Download All zip."); // Log when Download All is triggered
                              // Trigger download by navigating to the new backend download-all-zip route
                              window.open('/download-all-zip', '_blank');
                         };


                    } else {
                         // If not all complete or no files processed, ensure button is hidden
                         downloadAllBtn.classList.add('hidden');
                         console.log("Download All button hidden: Not all files complete or no results."); // Log when hidden
                         // Reset click handler to placeholder if button is hidden
                         downloadAllBtn.onclick = () => {
                            alert("Download All functionality is not yet fully implemented in this version.");
                         };
                    }
                }

            } catch (error) {
                // This catch block handles network errors or errors thrown by response.json()
                alert(`An error occurred during processing: ${error.message}`);
                console.error("Fetch error:", error);
                 // Set status to Error for all files if a general fetch error occurs
                 files.forEach(file => updateFileStatus(file.name, "Error", true, error.message));
            } finally {
                 // The clearAllBtn visibility is handled correctly within updateButtonStates
                 // when files are added or removed.
            }
        }

        // Initialize button states on page load
        updateButtonStates();

        // Helper function to parse filename and extension (used for constructing download URL)
        // This is a basic implementation. Node's path module is more robust.
        const path = {
            parse: (filePath) => {
                const lastDot = filePath.lastIndexOf('.');
                if (lastDot <= 0) { // Handle files with no extension or dot at the beginning
                    return { name: filePath, ext: '' };
                }
                return {
                    name: filePath.substring(0, lastDot),
                    ext: filePath.substring(lastDot)
                };
            },
            extname: (filePath) => {
                const lastDot = filePath.lastIndexOf('.');
                if (lastDot < 0) return '';
                return filePath.substring(lastDot);
            }
        };

    </script>
</body>
</html>
